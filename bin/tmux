#!/usr/bin/env bash
set -e

MAX_PANE=20

cd $DAISY_PATH
. $DAISY_PATH/.env

if [[ $1 == "-1" ]]; then
  tmux kill-session -t daisy-$ROS2_WS_CONTAINER_NAME
  exit 0
fi

if [ "$TMUX" ]; then
  echo "Session already attached. Exiting."
  exit 0
fi

if [ -z $1 ]; then
  TOTAL_PANE=4
else
  TOTAL_PANE=$1
fi

if [ ! -x "$(command -v tmuxinator)" ]; then
  echo "Installing tmuxinator"
  sudo apt install -y tmuxinator
fi

if [[ $TOTAL_PANE == ?(-)+([0-9]) ]]; then
  if [ $TOTAL_PANE -gt $MAX_PANE ]; then
    NEW_PANES=$MAX_PANE
  else
    NEW_PANES=$TOTAL_PANE
  fi

  cat << EOF > $DAISY_PATH/.tmux.yaml
  name: daisy-$ROS2_WS_CONTAINER_NAME
  on_project_exit: cd $DAISY_PATH && docker compose down
  tmux_options: -f .tmux.conf
  windows:
    - main:
        panes:
EOF

  for ((n=0;n<$NEW_PANES;n++))
    do echo "        -" >> $DAISY_PATH/.tmux.yaml
  done
  tmuxinator start -p .tmux.yaml

else
  TMUX_FILE="$1.yaml"
  if [ -f $TMUX_FILE ]; then
    tmuxinator start -p "$1.yaml"
  else
    echo "No $TMUX_FILE found"
  fi
fi
