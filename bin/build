#!/usr/bin/env bash

set -e

. $DAISY_PATH/.env
#ASCII ART REF: https://emojicombos.com/daisy
echo '''
===========DAISY TOOL===========
             ⢀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⢀⣤⣶⢾⣻⡷⣷⣦⡐⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⡀⣠⣿⣟⣾⣟⣯⢿⣳⣯⣇⣠⣤⣴⣶⣶⡶⣦⣄⡀⢀⠀⠀
⠀⠀⠀⠀⠀⠁⣾⢷⣏⣷⢿⣹⡿⣏⣷⢿⣷⣏⡿⣾⢷⣿⣏⡿⣿⡀⠁⠀
⠀⠀⢀⣠⣶⣶⢿⣻⢯⣟⡿⠙⠉⡉⠉⠙⠺⣯⣿⣻⢯⣷⣻⣽⢯⣷⠈⠀
⡄⢠⣿⣟⡷⣯⡿⣯⣿⡛⠁⠄⠡⢀⠡⠈⠄⡙⣷⣿⣻⣽⣻⢾⡿⡽⠀⠂
⡀⣿⣳⣯⢿⣻⣽⢷⣻⣇⠈⠄⡁⠂⠄⡁⠂⠄⣿⣾⣽⣳⡿⣯⠟⢀⠂⠀
⢂⠹⣻⢾⣟⣯⣟⡿⣽⣻⣆⠂⠄⡁⠂⠄⡁⣢⣿⢷⣯⢿⣽⢷⣄⠁⠀⠀
⠀⠂⠈⠻⢟⣾⣽⡟⢯⣿⡽⣿⣷⣶⣥⣶⣾⢿⣯⢿⣾⣻⡽⣟⣾⡆⠁⠀
⠀⠀⠀⠀⠀⠀⠀⠀⣾⣯⢿⣳⣟⣾⣽⣳⣿⣻⢾⣟⡷⣿⡽⣟⣷⠃⡄⠀
⠀⠀⠀⠀⠀⠀⠀⠀⣿⣾⡿⣏⣿⣾⣹⣷⠿⠹⣿⣾⢿⣷⣿⢿⠇⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠆⠹⣷⣻⣟⡾⣷⢯⡟⠀⠒⠀⠉⠉⠈⠉⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠙⠷⣟⡿⠽⠋⠀⠁⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠁⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
'''

if [[ -z $1 && -z $USE_ROS_DISTRO ]]; then
    echo "No ROS2 distro provided. Exiting now!"
    echo "usage: daisy-build [foxy, galactic, humble, iron]"
    exit 1
fi

SUPPORTED_DISTRO=( foxy galactic humble iron  )
if [[ ! " ${SUPPORTED_DISTRO[*]} " =~ " $1 " && -z $USE_ROS_DISTRO ]]; then
    echo "Unsupported $1 distro. Exiting now!"
    exit 1
fi

if [ -z $1 ]; then
    echo "Building Docker image for ROS2 $USE_ROS_DISTRO."
else
    echo "Building Docker image for ROS2 $1."
fi
echo ""

echo "This will stop all running containers. Do you want to continue?"
echo -n "Yes [y] or No [n]: " 
read reply
if [[ "$reply" == "n" || "$reply" == "N" ]]; then
    echo ""
    exit 1
fi

if [[ ! -z $1 && $USE_ROS_DISTRO != $1 && -f "$ROS2_WS_MOUNT/install.repos"  ]]; then
    echo "A rosinstall file has been detected in your workspace using ROS2 $USE_ROS_DISTRO."
    echo "Building your workspace using ROS2 $1 might cause compatibility issues."
    echo "Do you want to continue?"
    echo -n "Yes [y] or No [n]: " 
    read reply
    if [[ "$reply" == "n" || "$reply" == "N" ]]; then
        echo "Exiting now!"
        exit 1
    fi
fi

NO_SRC=false
if [ ! -d "$ROS2_WS_MOUNT/src" ]; then
    mkdir $ROS2_WS_MOUNT/src
    NO_SRC=true
fi

if [[ -f "$ROS2_WS_MOUNT/install.repos" && "$NO_SRC" == "true" ]]; then
    if [ ! -x "$(command -v vcs)" ]; then
        echo "Installing VCS Tool for exporting dependencies."
        curl -s https://packagecloud.io/install/repositories/dirk-thomas/vcstool/script.deb.sh | sudo bash
        sudo apt update -y
        sudo apt install -y python3-vcstool
    fi
    echo "Found a rosinstall file in your workspace." 
    echo "Downloading the following local repositories now:"
    echo ""
    cat $ROS2_WS_MOUNT/install.repos
    echo ""
    echo "in $ROS2_WS_MOUNT/src"
    echo ""
    vcs import $ROS2_WS_MOUNT/src --skip-existing --input $ROS2_WS_MOUNT/install.repos --recursive --workers 1
fi

if [[ -z $(ls -A "$ROS2_WS_MOUNT/src") ]]; then
   echo "$ROS2_WS_MOUNT/src is empty. Download all the repositorie before running daisy-build."
   exit 1
fi

if [ ! -z "$1"  ]; then
    echo "Updating .env to $1"
    sed -i "/USE_ROS_DISTRO/ s/.*/USE_ROS_DISTRO=$1/" $DAISY_PATH/.env
    . $DAISY_PATH/.env
fi

cd $DAISY_PATH
. setup.bash
echo "Stopping all running containers."
docker compose down
docker compose build

echo ""
echo "Done building the Docker image."
echo ""

if [ ! -f $ROS2_WS_MOUNT/.last_build_errors ]; then
    touch $ROS2_WS_MOUNT/.last_build_errors
fi

echo "Do you want to delete log build and install directories of your workspace?"
echo -n "Yes [y] or No [n]: " 
read reply
if [[ "$reply" == "n" || "$reply" == "N" ]]; then
    echo ""
    echo $(ls $ROS2_WS_MOUNT)
    exit 1
fi

sudo rm -rf $ROS2_WS_MOUNT/build
sudo rm -rf $ROS2_WS_MOUNT/install
sudo rm -rf $ROS2_WS_MOUNT/log

echo ""
echo $(ls $ROS2_WS_MOUNT)
